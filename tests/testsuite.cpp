#include <iostream>
#include <string>
#include <random>
#include "../bigInteger.h"

const char* GREEN = "\033[32m";
const char* RED   = "\033[31m";
const char* RESET = "\033[0m";

static int TEST_PASSED = 0;
static int TEST_TOTAL = 0;

void expectEqual(const std::string& result, const std::string& expected, const std::string& testName) {
	TEST_TOTAL++;
    if (result != expected) {
        std::cerr << RED << "[FAIL]" << RESET << " " << testName
                  << "\n  expected:\t" << expected
                  << "\n  result:\t" << result << "\n";
        std::exit(1);
    } 
    else {
       	TEST_PASSED++;
       	std::cout << GREEN << "[OK]" << RESET << " TEST #"
                  << TEST_PASSED << ": " << testName << '\n';
        
    }
}

void testConstructorsAndToString() {

	std::vector<std::vector<std::string>> inputs {
		{"0", "0"},
		{"-214243", "-214243"},
		{"+421431243", "421431243"},
		{"-89,421,421,415,984,404,848", "-89421421415984404848"},
		{"+41,414,784", "41414784"}
	};

	std::cout << "\n===== Constructors Tests =====\n";

	for (auto input : inputs) {
		BigInteger res(input[0]);
		std::string testName = "Constructor from "  + input[0] + " = " + input[1];
		expectEqual(res.toString(), input[1], testName);
	}
}

void testAddition() {

	std::vector<std::vector<std::string>> inputs {
		{"2141821492184391243", "4217428174217428128743", "4219569995709612519986"},
	    {"70487647593824219", "9924115781565", "70497571709605784"},
	    {"487784080160975351393328", "2158714841858398947", "487786238875817209792275"},
	    {"7593423", "1947112201", "1954705624"},
	    {"7848339694775159179533", "51352", "7848339694775159230885"},
	    {"701230989101399", "71510903", "701231060612302"},
	    {"2730086914", "4145620", "2734232534"},
	    {"809163457923022584197", "1769845642", "809163457924792429839"},
	    {"1715084237594599246610", "452337696069602714278789", "454052780307197313525399"},
	    {"17547", "738120", "755667"},
	    {"75030089131934421", "71047142851240003485", "71122172940371937906"},
	    {"123456789012345678901234567890",
	     "987654321098765432109876543210",
	     "1111111110111111111011111111100"},
	    {"999999999999999999999999999999",
	     "1",
	     "1000000000000000000000000000000"},
	    {"340282366920938463463374607431768211455",
	     "1",
	     "340282366920938463463374607431768211456"},
	    {"18446744073709551616",
	     "18446744073709551616",
	     "36893488147419103232"},
	    {"99999999999999999999999999999999999999",
	     "99999999999999999999999999999999999999",
	     "199999999999999999999999999999999999998"},
	    {"123456789123456789123456789",
	     "987654321987654321987654321",
	     "1111111111111111111111111110"},
	    {"1000000000000000000000000000000",
	     "999999999999999999999999999999",
	     "1999999999999999999999999999999"},
	    {"555555555555555555555555555555",
	     "444444444444444444444444444445",
	     "1000000000000000000000000000000"},
	    {"31415926535897932384626433832795",
	     "27182818284590452353602874713527",
	     "58598744820488384738229308546322"},

    	// neg + neg
	    {"-1", "-1", "-2"},
	    {"-999", "-1", "-1000"},
	    {"-18446744073709551616", "-1", "-18446744073709551617"},
	    {"-340282366920938463463374607431768211455", "-1",
	     "-340282366920938463463374607431768211456"},

	    // neg + pos (cancel / near-cancel)
	    {"-1", "1", "0"},
	    {"21424124312432143214", "-21424124312432143214", "0"},
	    {"-21424124312432143214", "21424124312432143214", "0"},
	    {"-1000", "1", "-999"},
	    {"-1", "1000", "999"},
	    {"-999999999999999999999999999999", "999999999999999999999999999999", "0"},
	    {"-1000000000000000000000000000000", "999999999999999999999999999999", "-1"},
	    {"-999999999999999999999999999999", "1000000000000000000000000000000", "1"},

	    // neg + pos (|neg| > |pos|)
	    {"-123456789", "123", "-123456666"},
	    {"-500000000000000000000", "1", "-499999999999999999999"},
	    {"-31415926535897932384626433832795",
	     "27182818284590452353602874713527",
	     "-4233108251307480031023559119268"},

	    // neg + pos (|pos| > |neg|)
	    {"-123", "123456789", "123456666"},
	    {"-27182818284590452353602874713527",
	     "31415926535897932384626433832795",
	     "4233108251307480031023559119268"},

	    // pos + neg (same as above but swapped)
	    {"123", "-123456789", "-123456666"},
	    {"1000000000000000000000000000000", "-999999999999999999999999999999", "1"},

	    // bigger random-ish signed
	    {"-2141821492184391243", "4217428174217428128743", "4215286352725243737500"},
	    {"70487647593824219", "-9924115781565", "70477723478042654"},
	    {"-487784080160975351393328", "2158714841858398947", "-487781921446133492994381"},
	    {"-7593423", "1947112201", "1939518778"},
	    {"7848339694775159179533", "-51352", "7848339694775159128181"},
	};

	std::cout << "\n===== Addition Tests =====\n";

	for (auto input : inputs) {
		BigInteger u(input[0]);
		BigInteger v(input[1]);
		BigInteger res = u + v;
		std::string testName = input[0] + " + " + input[1] + " = " + input[2];
		expectEqual(res.toString(), input[2], testName);
	}
}

void testSubstraction() {

	std::vector<std::vector<std::string>> inputs {
	    {"1977658236940224", "651590042294568", "1326068194645656"},
	    {"75461187755171", "517304281", "75460670450890"},
	    {"70452296111330601688", "87936153492635", "70452208175177109053"},
	    {"4039213765821", "20873176", "4039192892645"},
	    {"829668757738930555082492", "57118013204075227", "829668700620917351007265"},
	    {"79930024894517446660", "9688091891634896", "79920336802625811764"},
	    {"225609767017200992518536", "3345007627", "225609767017197647510909"},
	    {"20979519426418306753", "6100740899331886841", "14878778527086419912"},
	    {"796116116", "176607541", "619508575"},
	    {"2150552035192303", "14509322", "2150552020682981"},
	    {"217410827408127482174381243", "217410827408127482174381243", "0"},
	    {"4892148921748721843", "0", "4892148921748721843"},
	    {"0", "9743872470417089789237894243", "-9743872470417089789237894243"},
	    {"4219569995709612519986",
	     "4217428174217428128743",
	     "2141821492184391243"},
	    {"987654321098765432109876543210",
	     "123456789012345678901234567890",
	     "864197532086419753208641975320"},
	    {"1000000000000000000000000000000",
	     "1",
	     "999999999999999999999999999999"},
	    {"340282366920938463463374607431768211456",
	     "1",
	     "340282366920938463463374607431768211455"},
	    {"36893488147419103232",
	     "18446744073709551616",
	     "18446744073709551616"},
	    {"199999999999999999999999999999999999998",
	     "99999999999999999999999999999999999999",
	     "99999999999999999999999999999999999999"},
	    {"1111111111111111111111111110",
	     "123456789123456789123456789",
	     "987654321987654321987654321"},
	    {"1999999999999999999999999999999",
	     "1000000000000000000000000000000",
	     "999999999999999999999999999999"},
	    {"1000000000000000000000000000000",
	     "555555555555555555555555555555",
	     "444444444444444444444444444445"},
	    {"58598744820488384738229308546322",
	     "27182818284590452353602874713527",
	     "31415926535897932384626433832795"}
	};

	std::cout << "\n===== Substraction Tests =====\n";

	for (auto input : inputs) {
		BigInteger u(input[0]);
		BigInteger v(input[1]);
		BigInteger res = u - v;
		std::string testName = input[0] + " + " + input[1] + " = " + input[2];
		expectEqual(res.toString(), input[2], testName);
	}
}

void testMultiplication() {

	std::vector<std::vector<std::string>> inputs {
	    {"2754203557", "5852911", "16120108295004427"},
	    {"-52622358332", "6602906", "-347460485564512792"},
	    {"2264", "72964513758", "165191659148112"},
	    {"760", "673547121", "511895811960"},
	    {"-2892762", "-762375825717340", "2205371818353743893080"},
	    {"89703414892671", "8386401400468", "752288844282658122309170028"},
	    {"771454391014", "9518321", "7342950530530767494"},
	    {"548298381", "964475922", "528820586546082282"},
	    {"217489742189721423", "0", "0"},
	    {"-1284721742174082174821748423", "0", "0"},
	    {"0", "2187482174897214892174387088778437012874234", "0"},
	    {"0", "-2874173721489721849721843712743", "0"},
	    {
	        "12345678901234567890123456789012345678901234567890",
	        "98765432109876543210987654321098765432109876543210",
	        "1219326311370217952261850327338667885945115073915611949397448712086533622923332237463801111263526900"
	    },
	    {
	        "99999999999999999999999999999999999999",
	        "123456789123456789123456789123456789",
	        "12345678912345678912345678912345678899876543210876543210876543210876543211"
	    },
	    {
	        "-340282366920938463463374607431768211455",
	        "18446744073709551616",
	        "-6277101735386680763835789423207666416083908700390324961280"
	    },
	    {
	        "18446744073709551616",
	        "-18446744073709551616", 
	        "-340282366920938463463374607431768211456"
	    }
	    // karatsuba multiplication, above threshold (>= 80)

	};
	std::cout << "\n===== Multiplication Tests =====\n";

	for (auto input : inputs) {
		BigInteger u(input[0]);
		BigInteger v(input[1]);
		BigInteger res = u * v;
		std::string testName = input[0] + " x " + input[1] + " = " + input[2];
		expectEqual(res.toString(), input[2], testName);
	}
}

void testKaratsubaMultiplication() {

	std::cout << "\n===== Karatsuba Multplication Tests =====\n";
	std::vector<uint32_t> v1;
	std::vector<uint32_t> v2;

	std::mt19937_64 rng(42);

	uint64_t BASE = (1LL << 32);

	// random big numbers
	for (int i = 0; i < 10; i++) {
		v1.clear();
		v2.clear();
		for (int j = 0; j < 100; j++) {
			v1.push_back(static_cast<uint32_t>(rng() % BASE));
			v2.push_back(static_cast<uint32_t>(rng() % BASE));	
		}
		BigInteger x(v1);
		BigInteger y(v2);

		BigInteger expected = x * y;
		BigInteger res = karatsubaMultiplication(x, y);

		expectEqual(res.toString(), expected.toString(), "Karatsuba Multiplication");
	}

	// [2 ^ 32 - 1, 2 ^ 32 - 1, ..., 2 ^ 32 - 1]
	v1.clear();
	v2.clear();
	for (int j = 0; j < 120; j++) {
		v1.push_back(0xFFFFFFFF);
		v2.push_back(0xFFFFFFFF);
	}
	BigInteger x(v1);
	BigInteger y(v2);
	
	BigInteger expected = x * y;
	BigInteger res = karatsubaMultiplication(x, y);

	expectEqual(res.toString(), expected.toString(), "Karatsuba Multiplication");
}

void testDivision() {

	std::vector<std::vector<std::string>> inputs {
	    {"26697284", "863778", "30", "783944"},
	    {"807427093057608", "26", "31054888194523", "10"},
	    {"60190", "53294", "1", "6896"},
	    {"26756256627", "952", "28105311", "555"},
	    {"37566763373", "1603125023", "23", "694887844"},
	    {"591845670886977473540002", "140216", "4220956744501180133", "11274"},
	    {"783735919155", "854080351", "917", "544237288"},
	    {"95334448647", "404810", "235504", "74407"},
    	{
	        "4219569995709612519986",
	        "2141821492184391243",
	        "1970",
	        "181656106361771276"
    	},
	    {
	        "1111111110111111111011111111100",
	        "123456789012345678901234567890",
	        "9",
	        "9000000000900000000090"
	    },
	    {
	        "340282366920938463463374607431768211456", // 2^128
	        "18446744073709551616",                    // 2^64
	        "18446744073709551616",                    // 2^64
	        "0"
	    },
	    {
	        "199999999999999999999999999999999999998",
	        "99999999999999999999999999999999999999",
	        "2",
	        "0"
	    },
	    {
	        "1219326311370217952261850327338667885945115073915611949397448712086533622923332237463801111263526900",
	        "12345678901234567890123456789012345678901234567890",
	        "98765432109876543210987654321098765432109876543210",
	        "0"
	    },
	    {
	        "6277101735386680763835789423207666416083908700390324961280",
	        "340282366920938463463374607431768211455",
	        "18446744073709551616",
	        "0"
	    },
	    {
	        "95334448647",
	        "404810",
	        "235504",
	        "74407"
	    },
	    {
	        "1000000000000000000000000000000000000000",
	        "97",
	        "10309278350515463917525773195876288659",
	        "77"
	    },
	    {
	    	"4294967296", "1", "4294967296", "0"	
	    },

	    // tests for step 6 of Knuth algorithm D (D6 [Add Back])
	    {
	    	"144659075040145311177374690267887710956", 
	    	"56343573548904472842532843271",
	    	"2567445866",
	    	"56343573548904472842532843270"
	    },
    	{
    		"5685450231842382702618968800391528178973643028206900452601",
    		"2381421482871417209217432148218742143",
    		"2387418721438217438213",
    		"2381421482871417209217432148218742142"
    	}
	};

	std::cout << "\n===== Division Tests =====\n";

	for (auto input : inputs) {
		BigInteger u(input[0]);
		BigInteger v(input[1]);
		BigInteger quotient = u / v;
		BigInteger remainder = u % v;
		std::string testName = input[0] + " = " + input[1] + " * " + input[2] + " + " + input[3];
		expectEqual(quotient.toString(), input[2], testName);
		expectEqual(remainder.toString(), input[3], testName);
	}
}


int main() {
	std::cout << "===== BigInteger basic tests =====\n\n";

    testConstructorsAndToString();
    testAddition();
    testSubstraction();
    testMultiplication();
    testKaratsubaMultiplication();
    testDivision();

    
    std::cout << GREEN
              << "All tests passed: " << TEST_PASSED << "/" << TEST_TOTAL
              << RESET << "\n";
    return 0;
}